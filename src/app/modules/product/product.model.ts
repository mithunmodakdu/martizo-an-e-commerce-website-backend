import { model, Schema } from "mongoose";
import { IProduct } from "./product.interface";
import { VariantSchema } from "../variant/variant.model";

const ProductSchema = new Schema<IProduct>(
  {
    // main details
    title: {type: String, required: true},
    slug: {type: String, unique: true},
    description: {type: String},

    // categorization
    category: {type: Schema.Types.ObjectId, ref: "Category", required: true},
    subCategory: {type: Schema.Types.ObjectId, ref: "Category"},
    brand: {type: Schema.Types.ObjectId, ref: "Brand"},

    // price
    price: {type: Number, required: true},
    salePrice: Number,
    discountPercentage: {
      type: Number,
      default: function(){
        if(!this.salePrice){
          return 0;
        }

        return Math.round(((this.price - this.salePrice)/this.price)*100);
      }
    },

    // stock + variants
    stock: {type: Number, required: true},
    variants: {type: [VariantSchema], default: []},

    // media
    thumbnail: {type: String, required: true},
    images: {type: [String]},

    // labels for Shop menu sections
    isNewArrival: {type: Boolean, default: false},
    isBestSeller: {type: Boolean, default: false},
    isFlashSale: {type: Boolean, default: false},
    isMartizoExclusive: {type: Boolean, default: false},
    isTrending: {type: Boolean, default: false},

    // offers
    offers: {type: [Schema.Types.ObjectId], ref: "Offer", default: []},

    // rating system
    rating: { type: Number, default: 0},
    ratingCount: { type: Number, default: 0},

    // others
    sku: {type: String, required: true, unique: true},
    status: {type: String, enum: ["ACTIVE", "INACTIVE"], default: "ACTIVE"}

  },
  {
    timestamps: true
  }
);

ProductSchema.pre("save", async function(next){
  if(this.isModified("title")){
    const baseSlug = this.title.toLowerCase().split(" ").join("-");
    let slug = `${baseSlug}-product`;

    let counter = 1;

    while(await Product.exists({slug})){
      slug = `${slug}-${counter++}`;
    }

    this.slug = slug;
  }
  
  next();
})

export const Product = model("Product", ProductSchema);
































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































